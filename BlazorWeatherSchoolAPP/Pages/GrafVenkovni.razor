@page "/grafvenkovni"
@layout MainLayout

@using DBConnect.Models
@inject WeatherDB dataDB

@inject IJSRuntime JS
@using BlazorWeatherSchoolAPP.Source;


<RadzenContentContainer Name="main">
    <RadzenCard Style="width: 100%; ">
        <ChildContent>
            <RadzenText TextAlign="TextAlign.Left" TextStyle="TextStyle.H4">Venkovní hodnoty naměřených veličin</RadzenText>
            <p>
                Grafy zobrazují hodnoty maxima, minima a průměru naměřených venkovních veličin. V základním nastavení zobrazují hodnoty jednoho týdne,
                ale rozsah výběru je možné si nastavit pomocí kalendáře.
            </p>
            <br />
            <RadzenRow>
                <RadzenColumn SizeXS="12" SizeSM="12" SizeMD="6" SizeLG="6" SizeXL="6" Style="width: 100%; overflow-x:auto ">
                    <div class="rz-text-align-center">
                        <RadzenSelectBar @bind-Value=@Velicina class="rz-background-color-base-100 rz-border-black rz-border-radius-1" Size="ButtonSize.Small">
                            <Items>
                                <RadzenSelectBarItem Text="Teplota vzduchu" Value="1" />
                                <RadzenSelectBarItem Text="Rychlost větru" Value="2" />
                                <RadzenSelectBarItem Text="Vlhkost vzduchu" Value="3" />
                                <RadzenSelectBarItem Text="Dešťové srážky" Value="4" />
                                <RadzenSelectBarItem Text="Solární data" Value="5" />
                            </Items>
                        </RadzenSelectBar>
                    </div>
                </RadzenColumn>
                <RadzenColumn>
                    <div class="rz-text-align-center">
                        <MudDateRangePicker Class="bordered-datepicker2" tabindex="123" @ref="_picker" @bind-DateRange="@RozsahDat" MinDate="MinMaxDate.Min" MaxDate="MinMaxDate.Max">
                            <PickerActions>
                                <MudButton Class="mr-auto align-self-start" OnClick="@(() => _picker.Clear())">Vymazat</MudButton>
                                <MudButton OnClick="@(() => _picker.Close(false))">Zrušit</MudButton>
                                <MudButton Color="MudBlazor.Color.Primary" OnClick="@(() => _picker.Close())">Potvrdit</MudButton>
                            </PickerActions>
                        </MudDateRangePicker>
                    </div>
                </RadzenColumn>
            </RadzenRow>
        </ChildContent>
    </RadzenCard>
    <br />
    <RadzenCard Style="width: 100%; ">
        <ChildContent>
            <RadzenText TextAlign="TextAlign.Left" TextStyle="TextStyle.H5">Venkovní senzory:</RadzenText>
            <RadzenRow>
                <RadzenColumn SizeXS="12" SizeSM="12" SizeMD="6" SizeLG="6" SizeXL="6">
                    <RadzenCard>
                        <figure class="highcharts-figure">
                            <div id="chart1"></div>
                        </figure>
                    </RadzenCard>
                </RadzenColumn>
                <RadzenColumn SizeXS="12" SizeSM="12" SizeMD="6" SizeLG="6" SizeXL="6">
                    <RadzenCard>
                        <figure class="highcharts-figure">
                            <div id=chart2></div>
                        </figure>
                    </RadzenCard>
                </RadzenColumn>
            </RadzenRow>
        </ChildContent>
    </RadzenCard>

</RadzenContentContainer>


@code {
    public List<Quantities> last_data_awg;
    public List<Quantities> last_data;

    private DateRange? rozsahdat;
    public DateRange? RozsahDat { get { return rozsahdat; } set { rozsahdat = value; LoadData(); } }

    public DateRange? tyden = new DateRange(DateTime.Now.AddDays(-7).Date, DateTime.Now);

    public (DateTime? Min, DateTime? Max) MinMaxDate;

    Timer timer;

    private int velicina;
    public int Velicina { get { return velicina; } set { velicina = value; LoadData(); } }

    // Spouští JS funkci, která renderuje graf
    public async Task RenderCharts(List<Quantities> quantities, List<Quantities> quantitiesawg, int value)
    {

        if (value == 1)
        {
            var chart1 = GraphsGeneratorOut.BasicGraphVenkovniTeplota(quantities);
            var chart2 = GraphsGeneratorOutAwg.BasicGraphVenkovniTeplotaAwg(quantitiesawg);
            await JS.InvokeAsync<string>("RenderCharts", chart1, "chart1");
            await JS.InvokeAsync<string>("RenderChartsNew", chart2, "chart2");
        }
        else if (value == 2)
        {
            var chart3 = GraphsGeneratorOut.BasicGraphVenkovniVitr(quantities);
            var chart4 = GraphsGeneratorOutAwg.BasicGraphVenkovniVitrAwg(quantitiesawg);
            await JS.InvokeAsync<string>("RenderCharts", chart3, "chart1");
            await JS.InvokeAsync<string>("RenderChartsNew", chart4, "chart2");
        }

        else if (value == 3)
        {
            var chart5 = GraphsGeneratorOut.BasicGraphVenkovniVlhkost(quantities);
            var chart6 = GraphsGeneratorOutAwg.BasicGraphVenkovniVlhkostAwg(quantitiesawg);
            await JS.InvokeAsync<string>("RenderCharts", chart5, "chart1");
            await JS.InvokeAsync<string>("RenderChartsNew", chart6, "chart2");
        }

        else if (value == 4)
        {
            var chart7 = GraphsGeneratorOut.BasicGraphVenkovniSrazky(quantities);
            var chart8 = GraphsGeneratorOutAwg.BasicGraphVenkovniSrazkyAwg(quantitiesawg);
            await JS.InvokeAsync<string>("RenderCharts", chart7, "chart1");
            await JS.InvokeAsync<string>("RenderChartsNew", chart8, "chart2");
        }

        else if (value == 5)
        {
            var chart9 = GraphsGeneratorOut.BasicGraphVenkovniSlunce(quantities);
            var chart10 = GraphsGeneratorOutAwg.BasicGraphVenkovniSlunceAwg(quantitiesawg);
            await JS.InvokeAsync<string>("RenderCharts", chart9, "chart1");
            await JS.InvokeAsync<string>("RenderChartsNew", chart10, "chart2");
        }

    }

    // Načítání dat
    protected override async Task OnInitializedAsync()
    {
        // Minimální a maximílní datum pro volení rozsahu
        MinMaxDate = await dataDB.GetMinMaxDate();
        // Načtení dat při prvním spuštění
        await LoadData();
    }

    public async Task LoadData()
    {
        if (rozsahdat == null) { rozsahdat = tyden; StateHasChanged(); }
        DateTime start = rozsahdat.Start.Value;
        DateTime end = rozsahdat.End.Value.AddDays(1);

        if (velicina == 0) {
            velicina = 1; StateHasChanged();
        }

        // Záznami v rozsahu
        last_data_awg = await dataDB.GetSensorsDataAwg(start, end);
        last_data = await dataDB.GetSensorsData(start, end);

        await RenderCharts(last_data, last_data_awg, velicina);


    }
    private MudDateRangePicker _picker;

}
