@layout MainLayout
@using System.ComponentModel.DataAnnotations
@using System.Net.Mail
@using Microsoft.Extensions.Configuration;
@using Source
@inject EmailSend email;
@inject NotificationService NotificationService;

<MudForm @ref="form" @bind-IsValid="@success" @bind-Errors="@errors">
    <MudDialog>
        <DialogContent>
            <MudTextField T="string" Label="Vložte email" Required="true" RequiredError="Email je povinný!"
                          Validation="@(new EmailAddressAttribute() {ErrorMessage = "Neplatná emailová adresa!"})"
                          @bind-Value="model.Email" Variant="MudBlazor.Variant.Outlined" />
            <MudTextField T="string" Required="true" Label="Vložte připomínku či dotaz"
                          Variant="MudBlazor.Variant.Outlined" Lines="5" Clearable="true"
                          Validation="@(new Func<string, IEnumerable<string>>(TextStrength))"
                          RequiredError="Toto pole je povinné!"
                          @bind-Value="model.TextField" />
        </DialogContent>
        <DialogActions>
            
            <MudButton Variant="MudBlazor.Variant.Filled" OnClick="Cancel">Zrušit</MudButton>
            <MudButton StartIcon="@Icons.Material.Filled.Delete" Variant="MudBlazor.Variant.Filled" Color="MudBlazor.Color.Secondary" OnClick="@(()=>form.Reset())">Vymazat</MudButton>
            <MudButton EndIcon="@Icons.Material.Filled.Send" Color="MudBlazor.Color.Primary" OnClick="SendEmail" Disabled="@(!success)">Odeslat Email</MudButton>

        </DialogActions>
    </MudDialog>
</MudForm>




@code {

    // Proměnné sloužící pro ukládání stavu vyplněných polí - zda je validní či nikoliv
    bool success;
    string[] errors = { };
    MudForm form;


    // zde se ukládají data z formuláře
    DataTable model = new DataTable();

    // Nastavení pro tlačítko cancel/zrušit a zavření po odeslání
    [CascadingParameter] MudDialogInstance MudDialog { get; set; }
    void Cancel() => MudDialog.Cancel();

    // Podmínka pro vstup do textové pole - omezení vstupu
    private IEnumerable<string> TextStrength(string pw)
    {
        if (string.IsNullOrWhiteSpace(pw))
        {
            yield return "Toto pole je povinné.";
            yield break;
        }
        if (pw.Length < 40)
            yield return "Text musí být delší než 40 znaků.";
        if (pw.Length > 600)
            yield return "Text nesmí přesahovat 600 znaků";
    }


    public void SendEmail()
    {
        email.SendEmail(model);
        string msg = email.Message;
        Console.WriteLine(msg);
        if(msg == "Email byl odeslán") {
            ShowNotification(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = msg, Duration = 4000 });
        }
        else if (msg != "Email byl odeslán")
        {
            ShowNotification(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = msg, Duration = 4000 });

        }
        MudDialog.Close(DialogResult.Ok(true));
    }

    void ShowNotification(NotificationMessage message)
    {
        NotificationService.Notify(message);

    }

}





