@page "/datarekordy"
@layout MainLayout


@using DBConnect.Models
@inject WeatherDB dataDB

<RadzenContentContainer Name="main">
    <RadzenCard Style="width: 100%; ">
        <ChildContent>
            <RadzenText TextAlign="TextAlign.Left" TextStyle="TextStyle.H4">Tabulky rekordů a průměrů</RadzenText>
            <p>
                Vyberte si požadovaný den a v tabulce se zobrazí průměrné hodnoty, maxima a minima
                pro jednotlivé meteorologické veličiny
            </p>
            <br />
            <RadzenRow>
                <RadzenColumn>

                    <RadzenDatePicker Min="MinMaxDate.Min" Max="MinMaxDate.Max" @bind-Value=@Start DateFormat="dd/MM/yyyy">
                        <FooterTemplate>
                            <RadzenButton Click=@(args => Start = DateTime.Now) Text="Dnes" class="my-3 w-100" />
                        </FooterTemplate>
                    </RadzenDatePicker>

                </RadzenColumn>
                <RadzenColumn>
                    @if (last_data_awg != null)
                    {
                        <RadzenText TextAlign="TextAlign.Left" TextStyle="TextStyle.H6">Datum měření: @last_data_awg.SensorFirstTime.Date.ToString("dd/MM/yyyy")</RadzenText>
                    }
                </RadzenColumn>
            </RadzenRow>
        </ChildContent>
    </RadzenCard>
    <br />
    @if (last_data_awg != null)
    {
        <RadzenCard Style="width: 100%; ">
            <ChildContent>
                <RadzenText TextAlign="TextAlign.Left" TextStyle="TextStyle.H5">Venkovní senzory:</RadzenText>
                <RadzenRow>
                    <RadzenColumn Style="width: 100%; overflow-x:auto ">

                        <table class="table table-my-value record">
                            <tr>
                                <td colspan="1" class="table-secondary bold-font">Teplota a vlhkost</td>
                                <td colspan="1" class="table-secondary">Průměr</td>
                                <td colspan="1" class="table-secondary">Max</td>
                                <td colspan="1" class="table-secondary">Min</td>
                                <td colspan="1" class="table-secondary"></td>
                                <td colspan="1" class="table-secondary">Průměr</td>
                                <td colspan="1" class="table-secondary">Max</td>
                                <td colspan="1" class="table-secondary">Min</td>
                            </tr>
                            <tbody class="table-group-divider ">
                                <tr>
                                    <td>Teplota</td>
                                    <td>@last_data_awg.Quantities46.temp °C</td>
                                    <td>@last_data_awg.Quantities46.temp_max °C</td>
                                    <td>@last_data_awg.Quantities46.temp_min °C</td>
                                    <td>Relativní vlhkost</td>
                                    <td>@last_data_awg.Quantities46.hum %</td>
                                    <td>@last_data_awg.Quantities46.hum_max %</td>
                                    <td>@last_data_awg.Quantities46.hum_min %</td>
                                </tr>
                                <tr>
                                    <td>Heat index</td>
                                    <td>@last_data_awg.Quantities46.heat_index °C</td>
                                    <td>@last_data_awg.Quantities46.heat_index_max °C</td>
                                    <td>@last_data_awg.Quantities46.heat_index_min °C</td>
                                    <td>Rosný bod</td>
                                    <td>@last_data_awg.Quantities46.dew_point °C</td>
                                    <td>@last_data_awg.Quantities46.dew_point_max °C</td>
                                    <td>@last_data_awg.Quantities46.dew_point_min °C</td>

                                </tr>
                                <tr>
                                    <td>Wind Chill</td>
                                    <td>@last_data_awg.Quantities46.wind_chill °C</td>
                                    <td>@last_data_awg.Quantities46.wind_chill_max °C</td>
                                    <td>@last_data_awg.Quantities46.wind_chill_min °C</td>
                                </tr>
                            </tbody>
                            <tr>
                                <td colspan="1" class="table-secondary bold-font">Sluneční záření a UV index</td>
                                <td colspan="1" class="table-secondary">Průměr</td>
                                <td colspan="1" class="table-secondary">Max</td>
                                <td colspan="1" class="table-secondary">Min</td>
                                <td colspan="1" class="table-secondary"></td>
                                <td colspan="1" class="table-secondary">Průměr</td>
                                <td colspan="1" class="table-secondary">Max</td>
                                <td colspan="1" class="table-secondary">Min</td>
                            </tr>
                            <tbody class="table-group-divider">
                                <tr>
                                    <td>Intenzita slunečního záření</td>
                                    <td>@last_data_awg.Quantities46.solar_rad W/m&sup2</td>
                                    <td>@last_data_awg.Quantities46.solar_rad_max W/m&sup2</td>
                                    <td>@last_data_awg.Quantities46.solar_rad_min W/m&sup2</td>
                                    <td>UV index</td>
                                    <td>@last_data_awg.Quantities46.uv_index</td>
                                    <td>@last_data_awg.Quantities46.uv_index_max</td>
                                    <td>@last_data_awg.Quantities46.uv_index_min</td>
                                </tr>
                            </tbody>
                            <tr>
                                <td colspan="1" class="table-secondary bold-font">Srážky</td>
                                <td colspan="1" class="table-secondary">Průměr</td>
                                <td colspan="1" class="table-secondary">Max</td>
                                <td colspan="1" class="table-secondary">Min</td>
                                <td colspan="1" class="table-secondary"></td>
                                <td colspan="1" class="table-secondary">Den</td>
                                <td colspan="2" class="table-secondary"></td>
                            </tr>
                            <tbody class="table-group-divider">
                                <tr>
                                    <td>Intenzita srážek</td>
                                    <td>@last_data_awg.Quantities46.rain_rate_last_mm mm/hod</td>
                                    <td>@last_data_awg.Quantities46.rain_rate_last_mm_max mm/hod</td>
                                    <td>@last_data_awg.Quantities46.rain_rate_last_mm_min mm/hod</td>
                                    <td>Denní úhrn srážek</td>
                                    <td>@last_data_awg.Quantities46.rainfall_daily_mm mm</td>
                                </tr>
                            </tbody>
                            <tr>
                                <td colspan="1" class="table-secondary bold-font">Vítr</td>
                                <td colspan="1" class="table-secondary">Průměr</td>
                                <td colspan="1" class="table-secondary">Max</td>
                                <td colspan="1" class="table-secondary">Min</td>
                                <td colspan="1" class="table-secondary"></td>
                                <td colspan="1" class="table-secondary">Průměr</td>
                                <td colspan="2" class="table-secondary"></td>
                            </tr>
                            <tbody class="table-group-divider">
                                <tr>
                                    <td>Rychlost větru</td>
                                    <td>@last_data_awg.Quantities46.wind_speed_avg_last_10_min km/h</td>
                                    <td>@last_data_awg.Quantities46.wind_speed_last_max km/h</td>
                                    <td>@last_data_awg.Quantities46.wind_speed_last_min km/h</td>
                                    <td>Směr větru</td>
                                    <td>@last_data_awg.Quantities46.wind_dir_last °</td>
                                </tr>
                            </tbody>
                            @if (last_data_awg.Quantities56 != null)
                            {
                                <tr>
                                    <td colspan="1" class="table-secondary bold-font">Půda</td>
                                    <td colspan="1" class="table-secondary">Průměr</td>
                                    <td colspan="1" class="table-secondary">Max</td>
                                    <td colspan="1" class="table-secondary">Min</td>
                                    <td colspan="1" class="table-secondary"></td>
                                    <td colspan="1" class="table-secondary">Průměr</td>
                                    <td colspan="1" class="table-secondary">Max</td>
                                    <td colspan="1" class="table-secondary">Min</td>
                                </tr>
                                <tbody class="table-group-divider">
                                    <tr>
                                        <td>Teplota půdy</td>
                                        <td>@last_data_awg.Quantities56.temp_1 °C</td>
                                        <td>@last_data_awg.Quantities56.temp_1_max °C</td>
                                        <td>@last_data_awg.Quantities56.temp_1_min °C</td>
                                        <td>Vlhkost půdy</td>
                                        <td>@last_data_awg.Quantities56.moist_soil_1 %</td>
                                        <td>@last_data_awg.Quantities56.moist_soil_1_max %</td>
                                        <td>@last_data_awg.Quantities56.moist_soil_1_min %</td>
                                    </tr>
                                </tbody>
                            }
                        </table>
                    </RadzenColumn>
                </RadzenRow>
            </ChildContent>
        </RadzenCard>

    }
    @if (last_data_awg != null)
    {
        <br>
        <RadzenCard Style="width: 100%;  ">
            <ChildContent>
                <RadzenText TextAlign="TextAlign.Left" TextStyle="TextStyle.H5">Vnitřní senzory:</RadzenText>
                <RadzenRow>
                    <RadzenColumn Style="width: 100%; overflow-x:auto ">
                        <table class="table table-my-value record">
                            <tr>
                                <td colspan="1" class="table-secondary bold-font">Teplota a vlhkost</td>
                                <td colspan="1" class="table-secondary">Průměr</td>
                                <td colspan="1" class="table-secondary">Max</td>
                                <td colspan="1" class="table-secondary">Min</td>
                                <td colspan="1" class="table-secondary"></td>
                                <td colspan="1" class="table-secondary">Průměr</td>
                                <td colspan="1" class="table-secondary">Max</td>
                                <td colspan="1" class="table-secondary">Min</td>
                            </tr>
                            <tbody class="table-group-divider ">
                                <tr>
                                    <td>Teplota vnitřní WLL</td>
                                    <td>@last_data_awg.Quantities243.temp_in °C</td>
                                    <td>@last_data_awg.Quantities243.temp_in_max °C</td>
                                    <td>@last_data_awg.Quantities243.temp_in_min °C</td>
                                    <td>Teplota vnitřní AirLink</td>
                                    <td>@last_data_awg.Quantities326.temp °C</td>
                                    <td>@last_data_awg.Quantities326.temp_max °C</td>
                                    <td>@last_data_awg.Quantities326.temp_min °C</td>

                                </tr>
                                <tr>
                                    <td>Heat index WLL</td>
                                    <td>@last_data_awg.Quantities243.heat_index_in °C</td>
                                    <td>@last_data_awg.Quantities243.heat_index_in_max °C</td>
                                    <td>@last_data_awg.Quantities243.heat_index_in_min °C</td>
                                    <td>Heat index Airlink</td>
                                    <td>@last_data_awg.Quantities326.heat_index °C</td>
                                    <td>@last_data_awg.Quantities326.heat_index_max °C</td>
                                    <td>@last_data_awg.Quantities326.heat_index_min °C</td>
                                </tr>
                                <tr>
                                    <td>Relativní vlhkost vnitřní WLL</td>
                                    <td>@last_data_awg.Quantities243.hum_in %</td>
                                    <td>@last_data_awg.Quantities243.hum_in_max %</td>
                                    <td>@last_data_awg.Quantities243.hum_in_min %</td>

                                    <td>Relativní vlhkost AirLink</td>
                                    <td>@last_data_awg.Quantities326.hum %</td>
                                    <td>@last_data_awg.Quantities326.hum_max %</td>
                                    <td>@last_data_awg.Quantities326.hum_min %</td>
                                </tr>
                                <tr>
                                    <td>Rosný bod WLL</td>
                                    <td>@last_data_awg.Quantities243.dew_point_in °C</td>
                                    <td>@last_data_awg.Quantities243.dew_point_in_max °C</td>
                                    <td>@last_data_awg.Quantities243.dew_point_in_min °C</td>
                                    <td>Rosný bod AirLink</td>
                                    <td>@last_data_awg.Quantities326.dew_point °C</td>
                                    <td>@last_data_awg.Quantities326.dew_point_max °C</td>
                                    <td>@last_data_awg.Quantities326.dew_point_min °C</td>

                                </tr>

                            </tbody>
                            <tr>
                                <td colspan="1" class="table-secondary bold-font">Tlak</td>
                                <td colspan="1" class="table-secondary">Průměr</td>
                                <td colspan="1" class="table-secondary">Max</td>
                                <td colspan="1" class="table-secondary">Min</td>
                                <td colspan="4" class="table-secondary"></td>

                            </tr>
                            <tbody class="table-group-divider">
                                <tr>
                                    <td>Tlak vzduchu (přepočtený na hladinu moře)</td>
                                    <td>@last_data_awg.Quantities242.bar_sea_level hPa</td>
                                    <td>@last_data_awg.Quantities242.bar_sea_level_max hPa</td>
                                    <td>@last_data_awg.Quantities242.bar_sea_level_min hPa</td>
                                </tr>
                            </tbody>
                            <tr>
                                <td colspan="1" class="table-secondary bold-font">Kvalita ovzduší</td>
                                <td colspan="1" class="table-secondary">Průměr</td>
                                <td colspan="1" class="table-secondary">Max</td>
                                <td colspan="1" class="table-secondary">Min</td>
                                <td colspan="1" class="table-secondary"></td>
                                <td colspan="1" class="table-secondary">Průměr</td>
                                <td colspan="1" class="table-secondary">Max</td>
                                <td colspan="1" class="table-secondary">Min</td>
                            </tr>
                            <tbody class="table-group-divider">
                                <tr>
                                    <td>PM1 AirLink</td>
                                    <td>@last_data_awg.Quantities326.pm_1 μg/m&sup3</td>
                                    <td>@last_data_awg.Quantities326.pm_1_max μg/m&sup3</td>
                                    <td>@last_data_awg.Quantities326.pm_1_min μg/m&sup3</td>
                                    <td>Index kvality ovzduší AQI AirLink</td>
                                    <td class="@translatedText_desc[1]">@last_data_awg.Quantities326.aqi_val (@translatedText_desc[0])</td>
                                    <td class="@translatedText_desc_max[1]">@last_data_awg.Quantities326.aqi_val_max (@translatedText_desc_max[0])</td>
                                    <td class="@translatedText_desc_min[1]">@last_data_awg.Quantities326.aqi_val_min (@translatedText_desc_min[0])</td>
                                </tr>
                                <tr>
                                    <td>PM2,5 AirLink</td>
                                    <td>@last_data_awg.Quantities326.pm_2p5 μg/m&sup3</td>
                                    <td>@last_data_awg.Quantities326.pm_2p5_max μg/m&sup3</td>
                                    <td>@last_data_awg.Quantities326.pm_2p5_min μg/m&sup3</td>


                                </tr>
                                <tr>
                                    <td>PM10 AirLink</td>
                                    <td>@last_data_awg.Quantities326.pm_10 μg/m&sup3</td>
                                    <td>@last_data_awg.Quantities326.pm_10_max μg/m&sup3</td>
                                    <td>@last_data_awg.Quantities326.pm_10_min μg/m&sup3</td>
                                </tr>
                            </tbody>
                        </table>
                        <RadzenText TextAlign="TextAlign.Left" TextStyle="TextStyle.Overline">*PM1 - prachové částice o velikosti do 1 mikrometru </RadzenText>
                        <RadzenText TextAlign="TextAlign.Left" TextStyle="TextStyle.Overline">*PM2.5 - prachové částice o velikosti do 2.5 mikrometrů </RadzenText>
                        <RadzenText TextAlign="TextAlign.Left" TextStyle="TextStyle.Overline">*PM10 - prachové částice o velikosti do 10 mikrometrů</RadzenText>
                        <RadzenText TextAlign="TextAlign.Left" TextStyle="TextStyle.Overline">
                            *WLL je zkratka pro WeatherLink Live, což je hlavní
                            komunikační modul pro bezdrátový sběr dat ze senzorů meteostanice a připojených modulů, WLL
                            obstahuje vlastní sadu senzorů pro sledování pohody prostředí; aktuálně je umístěn v
                            místnosti ZB2-364
                        </RadzenText>
                        <RadzenText TextAlign="TextAlign.Left" TextStyle="TextStyle.Overline">
                            *AirLink je označení pro
                            modul sledování prachových částic ve vzduchu, tento modul je vybaven samostatnou sadou
                            senzorů pro měření pohody prostředí; aktuálně je umístěn v místnosti ZB2-364
                        </RadzenText>
                    </RadzenColumn>
            </RadzenRow>
            </ChildContent>
        </RadzenCard>

    }
</RadzenContentContainer>

@code {
    public Quantities last_data_awg;
    public string[] translatedText_desc;
    public String[] translatedText_desc_min;
    public String[] translatedText_desc_max;

    public (DateTime? Min, DateTime? Max) MinMaxDate;

    // Rozsahy pro výběr dat
    private DateTime? start;

    public DateTime? Start { get { return start; } set { start = value; LoadData(); } }

    Timer timer;
    DateTime currentTime;

    // Načítání dat
    protected override async Task OnInitializedAsync()
    {
        //První načtení
        await LoadData();

        // Minimální a maximílní datum pro volení rozsahu
        MinMaxDate = await dataDB.GetMinMaxDate();
        // Načtení dat při prvním spuštění
        timer = new System.Threading.Timer((_) =>
        {
            currentTime = DateTime.Now.ToLocalTime();
            if (currentTime.Minute == 0 || currentTime.Minute % 5 == 0 && currentTime.Second > 21)
            {
                InvokeAsync(async () =>
                {
                    await LoadData();
                });
            }

        }, null, 0, 30000);
    }

    public async Task LoadData()
    {

        if (start == null) { start = DateTime.Now; }

        DateTime start1 = start.Value;

        // Poslední záznam
        last_data_awg = await dataDB.GetDataTableHistoryAwg(start1);

        if (last_data_awg == null)
        {
            start = new DateTime(2023, 4, 1, 12, 10, 0);
            start1 = start.Value;
            last_data_awg = await dataDB.GetDataTableHistoryAwg(start1);
        }

        if (last_data_awg != null) {
            // překlad
            translatedText_desc = TranslateTextWithNumber(last_data_awg.Quantities326.aqi_val);
            translatedText_desc_min = TranslateTextWithNumber(last_data_awg.Quantities326.aqi_val_min);
            translatedText_desc_max = TranslateTextWithNumber(last_data_awg.Quantities326.aqi_val_max);
        }

        StateHasChanged();
    }
    private MudDatePicker _picker;

    string[] TranslateTextWithNumber(double inputnumber)
    {
        if (inputnumber <= 10) { return new string[] { "Dobrá", "good" }; }
        else if (inputnumber <= 20) { return new string[] { "Uspokojivá", "fair" }; }
        else if (inputnumber <= 25) { return new string[] { "Vyhovující", "moderate" }; }
        else if (inputnumber <= 50) { return new string[] { "Špatná", "poor" }; }
        else if (inputnumber <= 75) { return new string[] { "Velmi špatná", "very_poor" }; }
        else if (inputnumber <= 800) { return new string[] { "Extrémně špatná", "extremely_poor" }; }
        else { return new string[] { "Dobrá", "good" }; }
    }


    }




